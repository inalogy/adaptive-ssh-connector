<resource xmlns="http://midpoint.evolveum.com/xml/ns/public/common/common-3"
          xmlns:c="http://midpoint.evolveum.com/xml/ns/public/common/common-3"
          xmlns:icfs="http://midpoint.evolveum.com/xml/ns/public/connector/icf-1/resource-schema-3"
          xmlns:org="http://midpoint.evolveum.com/xml/ns/public/common/org-3"
          xmlns:q="http://prism.evolveum.com/xml/ns/public/query-3"
          xmlns:ri="http://midpoint.evolveum.com/xml/ns/public/resource/instance-3"
          xmlns:t="http://prism.evolveum.com/xml/ns/public/types-3"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          oid="d31ac928-b5df-4894-91a4-36b31184b13f">

    <name>ExchangeOnline-DistGroups</name>
    <lifecycleState>active</lifecycleState>
    <connectorRef>
        <filter>
            <q:text>connectorType = 'com.inalogy.midpoint.connectors.ssh.AdaptiveSshConnector'</q:text>
        </filter>
    </connectorRef>
    <connectorConfiguration xmlns:icfc="http://midpoint.evolveum.com/xml/ns/public/connector/icf-1/connector-schema-3">
        <icfc:configurationProperties
                xmlns:cfg="http://midpoint.evolveum.com/xml/ns/public/connector/icf-1/bundle/com.inalogy.midpoint.connectors.ssh/com.inalogy.midpoint.connectors.ssh.AdaptiveSshConnector">
            <cfg:shellType>powershell</cfg:shellType>
            <cfg:schemaFilePath>schemaPath/schemaConfiguration.json</cfg:schemaFilePath>
            <cfg:dynamicConfigurationFilePath>schemaPath/dynamicConfiguration.json</cfg:dynamicConfigurationFilePath>
            <cfg:host>10.50.110.1</cfg:host>
            <cfg:sshResponseTimeout>300</cfg:sshResponseTimeout>
            <cfg:port>22</cfg:port>
            <cfg:username>mp-ssh</cfg:username>
            <cfg:privateKeyFilePath>absolutePath/encrypted.pem</cfg:privateKeyFilePath>
            <cfg:authenticationScheme>publicKey</cfg:authenticationScheme>
            <cfg:usePersistentShell>true</cfg:usePersistentShell>
            <cfg:passphrase>
                <t:encryptedData>
                    <t:encryptionMethod>
                        <t:algorithm>http://www.w3.org/2001/04/xmlenc#aes256-cbc</t:algorithm>
                    </t:encryptionMethod>
                    <t:keyInfo>
                        <t:keyName>FIXME</t:keyName>
                    </t:keyInfo>
                    <t:cipherData>
                        <t:cipherValue>FIXME</t:cipherValue>
                    </t:cipherData>
                </t:encryptedData>
            </cfg:passphrase>
        </icfc:configurationProperties>
    </connectorConfiguration>
    <schema/>
    <schemaHandling>
        <objectType>
            <kind>account</kind>
            <intent>default</intent>
            <default>true</default>
            <delineation>
                <objectClass>ri:EXOMailUser</objectClass>
            </delineation>
            <focus>
                <type>UserType</type>
            </focus>
            <activation>
                <existence>
                    <outbound>
                        <name>Never try to delete</name>
                        <strength>weak</strength>
                        <expression>
                            <value>true</value>
                        </expression>
                    </outbound>
                </existence>
            </activation>
            <correlation>
                <correlators>
                    <filter>
                        <ownerFilter>
                            <q:equal>
                                <q:matching>stringIgnoreCase</q:matching>
                                <q:path>emailAddress</q:path>
                                <expression>
                                    <variable>
                                        <name>upn</name>
                                        <path>$shadow/attributes/name</path>
                                    </variable>
                                    <script>
                                        <code><![CDATA[
                                            return upn?.split('@')[0] + '@test.com'
                                            ]]></code>
                                    </script>
                                </expression>
                            </q:equal>
                        </ownerFilter>
                    </filter>
                </correlators>
            </correlation>

            <!-- association of users to ExchangeOnline Dist Groups -->
            <association>
                <ref>ri:memberOf_distribution-group</ref>
                <displayName>ExchangeOnline Distribution Groups</displayName>
                <tolerant>false</tolerant>
                <kind>entitlement</kind>
                <intent>distribution-group</intent>
                <direction>subjectToObject</direction>
                <associationAttribute>ri:memberOf</associationAttribute>
                <valueAttribute>icfs:uid</valueAttribute>
            </association>

            <synchronization>
                <reaction>
                    <name>deleted -&gt; unlink focus</name>
                    <situation>deleted</situation>
                    <actions>
                        <unlink/>
                    </actions>
                </reaction>
                <reaction>
                    <name>unlinked -&gt; link</name>
                    <situation>unlinked</situation>
                    <actions>
                        <link/>
                    </actions>
                </reaction>
                <reaction>
                    <name>unmatched -&gt; do nothing</name>
                    <situation>unmatched</situation>
                </reaction>
            </synchronization>
        </objectType>

        <objectType>
            <kind>entitlement</kind>
            <intent>distribution-group</intent>
            <default>true</default>
            <delineation>
                <objectClass>ri:EXODistributionGroup</objectClass>
            </delineation>
            <focus>
                <type>RoleType</type>
                <archetypeRef oid="00000000-0000-0000-0000-000000000328"/>
            </focus>

            <attribute>
                <ref>icfs:name</ref>
                <outbound>
                    <strength>strong</strength>
                    <source>
                        <path>name</path>
                    </source>
                </outbound>
            </attribute>
            <attribute>
                <ref>ri:primarySmtpAddress</ref>
                <outbound>
                    <strength>strong</strength>
                    <source>
                        <path>emailAddress</path>
                    </source>
                </outbound>
            </attribute>

            <attribute>
                <ref>ri:groupType</ref>
                <outbound>
                    <strength>weak</strength>
                    <source>
                        <path>extension/securityEnabled</path>
                    </source>
                    <expression>
                        <script>
                            <code>
                                if (securityEnabled){
                                    return "MailUniversalSecurityGroup"
                                }
                                return "MailUniversalDistributionGroup"
                            </code>
                        </script>
                    </expression>
                </outbound>
            </attribute>

            <attribute>
                <ref>ri:description</ref>
                <outbound>
                    <strength>strong</strength>
                    <source>
                        <path>description</path>
                    </source>
                </outbound>
            </attribute>
            <attribute>
                <ref>ri:alias</ref>
                <outbound>
                    <strength>strong</strength>
                    <source>
                        <path>extension/alias</path>
                    </source>
                </outbound>
            </attribute>
            <attribute>
                <ref>ri:primarySmtpAddress</ref>
                <outbound>
                    <strength>strong</strength>
                    <source>
                        <path>emailAddress</path>
                    </source>
                </outbound>
            </attribute>
            <attribute>
                <ref>ri:displayName</ref>
                <outbound>
                    <strength>strong</strength>
                    <source>
                        <path>displayName</path>
                    </source>
                </outbound>
            </attribute>
            <activation>
                <existence>
                    <outbound>
                        <strength>weak</strength>
                        <expression>
                            <value>true</value>
                        </expression>
                    </outbound>
                </existence>
            </activation>
            <correlation>
                <correlators>
                    <filter>
                        <ownerFilter>
                            <q:equal>
                                <q:matching>stringIgnoreCase</q:matching>
                                <q:path>name</q:path>
                                <expression>
                                    <path>$shadow/attributes/name</path>
                                </expression>
                            </q:equal>
                        </ownerFilter>
                    </filter>
                </correlators>
            </correlation>

            <synchronization>
                <defaultSettings>
                    <reconcile>false</reconcile>
                </defaultSettings>
                <opportunistic>true</opportunistic>
                <reaction>
                    <situation>linked</situation>
                </reaction>
                <reaction>
                    <situation>unlinked</situation>
                    <actions>
                        <link/>
                    </actions>
                </reaction>
            </synchronization>
        </objectType>
    </schemaHandling>
    <capabilities/>

    <consistency>
        <deadShadowRetentionPeriod>PT1S</deadShadowRetentionPeriod>
    </consistency>
</resource>
